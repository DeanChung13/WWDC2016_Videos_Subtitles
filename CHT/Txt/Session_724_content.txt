Apple Push Notification Service的新功能
歡迎來到724號會議
關於Apple Push Notification Service的新功能
我是Mayur Mahajan
我從事於Apple PushNotification Service 即APNS
我迫不及待跟你們分享APNS中即將上線的功能
首先讓我們回顧一些過去已經增強的功能
這些功能是在去年發佈的
首先我們提供了一種新的服務端協議
基於HTTP/2來進行持續的推送
HTTP/2協議傳輸採用二進制編碼
支持在一個連接中使用多種數據流
並且十分快速
這種新的協議讓推送一則消息變得很容易
這種新的協議支持即時的反饋
從而可以立即獲知設備的token是否處於激活狀態
這種協議還允許發送更多字節的有效載荷
最多可以發送4000字節
你可以利用這一點來創建更加豐富的應用
此外 我們還簡化了證書的處理
所以你們現在只需要維護更少的證書
這些證書被用來與APNS進行連接
我們獲得了很多積極的反饋這些反饋來自開發者社區
我們現在每秒推送着數十萬條通知
歸功於使用了這種新的協議
如果你還沒有試用過新的推送服務那麼你真的應該去嘗試一下了
讓我們重新來看一下那些關鍵的步驟關於發送一則Push Notification
右下角是客戶端應用
右上角是供應商
它是一個服務端組件用來連接APNS
並且發送Push Notification
目前在你開始發送通知之前
你應該註冊Push Notification
通過你的開發者帳號來完成
這樣你的應用就可以向操作系統來註冊推送服務
當它在設備上運行的時候左下角
設備會向APNS請求一個token
這個token用來代表這個應用
設備會將該token傳遞給你的應用
這個token具有唯一的標識性
代表了你的應用運行在了相應的設備上
你的應用應該將該token轉發給供應商
現在供應商服務
就可通過客戶端的證書連接到APNS
然後發送一個標準的HTTP/2的POST請求
從而向那個token發送一次推送
HTTP/2供應商接口將提供一個即時迴應
來表示是否能成功發送
同時 APNS收到
並且會驗證這個推送請求是否有效
如果發生錯誤就會報告這個token無效
APNS會返回一個狀態碼爲400的錯誤信息
或者“無效請求”以及相關的錯誤指示
舉例來說 設備token無效
新的供應商協議會提供即時的反饋
如果設備token被移除了
那麼你會得到一個HTTP/2的迴應其狀態碼410或代表移除的文字描述
並且該回應中還提供了一個時間戳來標識
APNS何時知道該設備token被移除了
我們還簡化了證書的相關處理
作爲新的供應商協議的一部分
你現在只需要規定一次證書
來覆蓋你的應用complication以及Voip Push
這個證書既可以在開發環境
又可以在生產環境中使用
這樣可以減少很多麻煩在管理 新建
以及撤回證書的過程中開發者可以避免一些過去出現的麻煩
現在 讓我們來聽一下像你們開發者的反饋
並且我們已經認識到了
簡化工作流程的重要性
那些在發送推送通知中涉及到的流程
我們意識到管理證書實在是太複雜了
對於很多應用來說
所以今天我們非常激動的通知一個新的
簡潔的認證機制會引入到APNS中
token認證機制介紹
在APNS中的應用
Token認證機制通過用供應商的token
在發送通知的過程中替代了客戶端的證書
這種認證token是用來
簡化服務端與APNS之間的連接方式
此外 這些token非常容易通過程序生成
所以再也不用擔心需要去處理那些證書過期的問題了
這一切能實現依賴於JSON Web token
作爲一種生成認證證書的機制
有很有多種程序語言選項的庫可以用
來生成這些token
現在 在我們討論一些細節之前
關於token認證機制的細節
讓我們首先了解
證書認證機制是如何工作的
你們可以選擇參加
通過開發者賬號獲得一個客戶端證書
當使用同一種認證連接APNS的時候
APNS會提供一個服務端的證書
用來讓你信任和效驗
就像握手一樣
你的供應商會爲客戶端證書籤名
從而APNS會進行效驗並且建立證書
此時一個彼此信任的連接就建立了
在APNS與供應商之間
任何通過這個連接發送的推送都會附加
一個客戶端證書中的應用標示
當使用token認證機制的時候
你應通過賬戶選擇一個token的簽名鍵值
然後你的供應商建立一個PLS連接
並不需要包含一個客戶端證書
但是 在通過這個連接發送通知之前
供應商需要創建一個認證的token
包含你的團隊ID
然後爲它簽名
現在就可以通過這個連接發送通知了
每一個通知消息
在簽名後都需要包含這個認證token
這個請求還需要包含應用相關的信息
APNS首先驗證來自服務端的token
然後再處理請求
如果請求被成功的處理了
APNS就會返回一個包含成功信息的迴應
如果請求中沒有token信息
或者token信息無效
返回的迴應會包含一個錯誤指示信息
作爲一個提醒類型的服務APNS不會在有錯誤發生時關閉連接
現在讓我們來看一下如何生成一個供應商token
你首先需要配置一個簽名鍵值
在證書、身份
配置下設置(開發者賬戶中)
這樣產生了一個公共-私有的鍵值面板
然後這個私有的鍵就可以使用了
用來當作密碼爲token數據簽名
Apple會使用對應的公匙
來對token進行效驗
下面讓我們來關注下如何生成token
上面是一個例子 用來說明
一個JSON Web Token在參與請求中是什麼樣子的
讓我們看一下該JSON Web token結構
你可以看到它有三個部分
每一個部分都是被base-64編碼過的URL的形式
一段時期內這種形式都不會改變
下面被解碼的部分代表着該Web token
第一個部分是header
它包括了一些屬性
用來描述了token簽名使用的算法
在我們的例子中 使用的是ES256
它還描述了鍵的標識符
這個鍵是用來給token簽名的
claim部分包含了用於效驗的數據
那就是你的開發者的團隊ID
可以通過你的開發者賬戶獲得
claim部分中的下一個屬性是一個初始化的時間戳
用來表示時間點
token的最後一個部分一個簽名
通過對一些數據使用了加密算法後再進行了base-64的編碼
這些數據來源於header以及claim部分
這樣避免了任何未授權的幹預來自token
這裏是一個HTTP/2創建的一個使用token認證的請求
就像你看到的那樣
這個請求包括了一個header區以及一個數據區
header區由很多APNS相關的變量組成
現在你可以看到header區了
包含了一個認證header
在“bearer”值後面是帶簽名的供應商token
如果這個帶token認證的請求是有效的
那麼迴應就會返回一個200的狀態碼或者“OK”的信息
這裏可以看到這種迴應的結構
如果供應商token是無效的
會返回403的狀態碼或者“禁用”的信息
現在APNS會要求週期性的產生新的token
如果token存在的時間太長
迴應同樣會返回403或者“禁用”的信息
並且會指示出token過期了
APNS會要求token的創建時間
必須在一個小時以內
但並不是每一個連接都需要產生一個新的token
實際上處於性能的考慮 我們建議
在token有效的時候就一直使用它
所以這裏還有一些更多的關於token認證的細節
就如之前提到的供應商token
需要週期性的被創建
但是 需要注意鍵值“簽名”不會失效
如果你覺得“簽名”鍵值需要變化
那麼可以在開發者賬戶中撤銷它
然後部署一個新的鍵
作爲一個提醒類型的服務APNS會長久支持證書認證方式
並且也會長久支持token認證方式
並且這種token認證方式會在今年內晚些時候出現
本次會議的更多的信息請訪問頁面
developer.apple.com/wwdc16/724
下面是一些關於Notification的相關會議
你可能會感興趣：
主題爲Introductionto Notifications的會議
在週三的上午9點於Pacific Heights召開
接下來主題爲Advanced Notifications的會議
會在週三的上午10點於Pacific Heights召開
我們希望到時候還再能看到你們
謝謝大家