高級通知推送 演講708
早上好
歡迎來到“高級通知推送”
我是Michele今天我們的話題
包括在iOS X系統上的新通知
我們會從新通知的用戶界面開始
我們會先介紹一下本次演講的大致內容然後會講iOS X系統中的改動
之後我們會介紹如何把媒體附件
插入新通知我們會給大家介紹
如何在新的iOS X系統通知中定製用戶界面
我們先來聊一聊用戶界面的概況
iOS X的用戶通知設計十分精美
大家可以看到這個鎖屏界面
看這動畫製作以及擡起喚醒
這個是橫幅
可以看出相比以往版本可讀性更高了
裏面的內容量也更大了
上面顯示了標題 副標題這個是Notification Center
在這三個不同模塊裏每一條通知樣式相同
在iOS 8中 我們引入了動作通知
你可以給通知添加動作
互動性也因此變得更高
也讓用戶處理推送消息更快捷方便
我們在iOS 9引入了快速回復來增強可操作通知
這項功能使用戶通過在推送消息中輸入
用文字來回復
在iOS X推送功能比以往更加強大
因爲現在推送功能對我們的設備而言更加重要
因爲我們每時每刻都在使用推送
它是我們與設備互動的重要方式
同時也是用戶與你的應用互動的重要方式
所以在iOS X系統中你可以點擊一條推送消息
消息欄會展開
顯示更具體且有針對性的用戶界面
針對你的應用爲你的內容服務
它顯示更多細節對用戶來說更實用
用戶可以點擊不同操作
用戶界面會更新且顯示出變化
以及操作的結果
日曆就是一個簡單的例子
還有“找朋友”
當你的朋友跟你共享位置
你可以立即在推送中看到他們的位置
你就可以估計這次會面他們會遲到多久
還有用於“照片分享”的通知
當你在iCloud上分享一張照片時你可以直接看到這張照片
在推送欄中 而不用打開應用
你還可以點贊或者回復而不用打開應用
專門查看那張照片
最後 消息
這還不是所有的
從iOS 8起 消息開始支持快速回復
但每次只能看到一條消息而且也只能回覆一條
現在你可以看到整個對話
當你打開通知回覆
你可以等待朋友的回覆也可以發送更多消息
這就是新版的iOS X中通知的力量
但是如果這就完了的話
我就不用在這裏站半個小時了
並給你演示iOS X裏所有新通知了
所以我今天想介紹給大家最重要的功能是
剛纔我演示的所有那些
都是用iOS X中我們擴展的新的API實現的
你也同樣可以像我們這樣做到這些
並把所有這些功能添加到你自己的應用和通知中
第一個可以做的是媒體附件
媒體附件
我從朋友那裏最經常收到的通知
是他們分享的照片或視頻
所以很重要的是把這些內容
這些已經分享的內容放到通知中
以便能更快看到
而不用打開應用下載
不過這樣做的問題是 你也知道
推送通知是通過推送負載消息來傳送的
儘管我們去年將大小增到了4KB
這依然遠不夠發送一整張照片
即使添加到通知的是很小的一張照片
我們該如何解決呢？
我們使用新的服務擴展
在今天早些時候的演講中介紹過
從服務擴展下載附件時
你需要先將通知設爲可變的
就像這裏的消息負載
我發送一個可變的內容標註然後添加一個引用
指向需要推送的附件
在這個例子裏我用了一個簡單的鏈接
你也可以使用一個標識符
只要你的程序知道如何從你的服務器中下載即可
做完這些後
推送成功發送到設備
系統會自動運行你的服務擴展
在服務擴展中
你可以通過各種方式下載附件
比如你可以使用URL會話
這樣系統就可以幫你管理資源
隨後通知就會和附件一起被推送到設備
我們來看看一小段關於如何實現的代碼
這只是服務擴展最基本的一個例子
在最上方 我實現了didReceive請求
withContentHandler
它會在收到通知時被調用
然後就要下載附件了
我可以使用URL會話下載附件
或其它你喜歡的技術
當文件下載到本地時
我可以創建一個通知附件對象
創建完成後把它添加到通知的內容裏
然後傳給系統 準備發送給用戶
完成這些之後 這就是我的通知
附帶精美的圖片用戶可以直接看到
而不需等待下載或者打開應用
而且你可以看到 通知附件
同樣支持可操作通知
你可以直接在這裏點贊或評論
媒體附件 簡單回顧一下
它支持本地或遠程通知
我們只談到了本地的
我們只談了遠程的 因爲本地的簡單
你只需創建通知附件對象
在安排通知時創建 就可以了
附件支持圖片 音頻 或者視頻
系統會爲這三種類型提供可自定義的UI
你需要在服務擴展中下載附件
但是一定要記住
服務擴展的運行時間是有限制的
附件大小也是有限制的
因爲它們的目的是和通知一起發送
而不是爲了把完整內容發送給用戶
你可能希望發送一個縮小版的圖片
然後讓用戶打開應用下載高清圖片
或者你也可以發送一個短的視頻剪輯
如果發送的是視頻內容
然後讓用戶打開程序來下載完整視頻
當你下載它時 把它添加到通知
這時系統會接管
幫你管理這個文件
你不用操心這個文件
系統會把它放到一個單獨的區域
處理所有數據
哦對 我差點忘記了
當然了 我們支持GIF格式
附件功能非常棒
並且爲通知提供了豐富的界面
最開始的時候我說過你可以實現所有的
所有我演示過的新的通知功能
以及日曆 消息
它們肯定不用附件
它們用的是自定義用戶界面
這就是我們現在要說的
創建自定義用戶操作界面時
你要用到我們給標準通知添加的第二個擴展點
它就是NotificationContentExtension
NotificationContentExtension允許你
添加自己的自定義視圖
你可以隨心所欲地設計
但是最重要的限制在於
你的視圖是不可交互的
它不接受點擊事件 用戶不能點擊
但是通知依然是可交互的因爲你可以使用通知動作
擴展可以處理這些動作
我們一會兒會演示如何做到
自定義用戶界面
我說過我們可以實現
和系統相同的功能
我們先看看日曆的行爲
然後再來看我們如何模仿
這是一個日曆通知
在最上方有一個頁眉
頁眉上有通知圖標點擊它會打開應用
應用名和關閉按鈕
這是系統爲所有類型通知提供的標準UI
頁眉下方是自定義內容
這是你的通知擴展存在的地方
是你繪製內容的地方
顯示所有你希望用戶看到的細節
在它們下面
是系統顯示的默認內容
和負載一起發送的內容
它是iOS 9之前版本通知裏的可見信息
在最下方
是通知中用戶可點擊和交互的動作
用戶點擊後 用戶界面會更新
顯示操作結果
來看看我們自己怎麼實現
通知內容擴展
首先以派對邀請爲例
派對很有趣 我們週四就有對吧？
這是要展示的基本通知
當你推送通知用戶就會看到它
和你期待的很像
咱們看看如何擴展
讓它顯示我們想要的自定義界面
首先要做的是
在你的應用裏添加新的目標
通過使用Xcode提供的模板
NotificationContentExtension模板
這個模板會在新目標裏創建三個文件
一個視圖控制器主界面的StoryBoard
以及info.plist你可以在它裏面自定義擴展
這是NotificationContentExtension的視圖控制器
如你所見它不過是一個UI視圖控制器的子類
就是你熟悉的普通視圖控制器
它還實現了NotificationContentExtension協議
通過它系統就會知道
你想把這個視圖控制器應用於通知
這個協議只有一個強制方法
這個強制方法是didReceive notification
如你所見
這個方法
會和視圖控制器的生命週期方法一起被調用
在通知被髮送出去
發送到擴展的時候
所以當用戶展開通知
你會接收到所有視圖控制器的調用
以及額外的這個方法
所以你可以接收通知對象
更新UI 顯示不同的東西
下一步是告訴系統
如何找到你的內容擴展
內容擴展使用的通知類別
和你用來註冊通知動作的相同
在這個例子裏我使用的是event-invite
爲我的派對邀請函
擴展也可以關聯
多個類型 以便你想把同樣的UI
應用到類型不同但界面類似的通知
在這個例子裏 我使用的是event-invite或event-update
它們的UI非常相似
我可以使用不同的種類因爲它們的動作不同
我都設置好了
我有了視圖控制器
現在我想添加些自定義視圖繪製我自己的UI
這是個視圖控制器我在Storyboard里加入了一些標籤
我在此沒把標籤顯示出來
收到通知時 我從內容中抽取信息
獲取我需要的信息 然後設置內容
設置我剛剛創建的標籤
你可以看到 我還有些自定義信息
而不只有隨負載傳遞的標準信息
因爲我想展示些負載的標準信息之外的內容
在這個例子裏 我展示了位置
因爲知道派對在哪兒至關重要
這就是我的通知了
可以看到 有一些自定義內容
我用不同風格的自定義標籤繪製了自己的UI
但這個通知有兩個問題
第一個是內容區域太大
我不需要那麼多空間 全都是空的
我需要展示的內容小得多
第二個問題就是默認內容重複了
我並不需要它因爲已經展示過了
同樣的信息在我自定義樣式的最上方
這兩個問題都可以解決
我們先解決第二個因爲它更簡單
這是你info.plist裏一個附加屬性
你可以把隱藏默認信息
設置爲“是”這樣就看不到默認信息了
系統不會再添加
第二個問題是我的通知尺寸
但因爲這只是視圖控制器的問題
我可以像重設視圖控制器尺寸一樣重設通知尺寸
在這個例子中 我重設內容大小
你也可以拋開佈局設置約束
你也可以用Storyboard兩個方法都可行
處理完這兩個問題之後
我的推送就是這個樣子
看起來好了不少
大小正合適
沒有重複內容
但你發現新問題了嗎？
通知剛出現時尺寸不對
所以系統不得不顯示動畫並重設通知大小
讓它達到合適的尺寸
我再來演示一遍
看到了嗎？我們可以改進它
發生這個的原因在於系統需要知道
最終展示的通知尺寸在一開始顯示時就要知道
這樣動畫纔會正常
但你的擴展還沒有加載
當系統開始顯示通知的時候
所以你需要提前告訴系統
你最終想要的尺寸在你的代碼運行之前
問題在於這些通知
運行在不同設備上環境不同尺寸不同
所以我們的解決方法就是設定內容尺寸比例
這裏定義了長寬比
你希望把它應用於內容部分
但是 當然了這個辦法並不一定可行
因爲不同內容的尺寸不同
你不知道接收的內容會是什麼
但你依然需要顯示所有內容
所以有的時候這個方法不可行
但是如果你可以找到適用於你的通知的尺寸的話
用這個方法足矣
使用這個方法後的結果
就是現在這個新的通知
它從展示最初就是合適的尺寸
回顧一下剛纔的內容
我們想創建自定義通知UI
我們從自定義UI開始
非常基礎但包括了我所有的自定義內容
還包括了負載以外的附加信息
但是尺寸不對
所以我們修改了顯示尺寸通過設置初始長寬比
然後我們解決了重複內容
通過設置隱藏默認信息標誌
從最初到現在這個樣子
這看起來比最初好得多
仍然不算完美但是我今天確實打算
接着改進它
我還知道另一個讓通知看起來更好的技巧
我們可以添加圖片
圖片總是好的尤其是發派對邀請函的時候
同樣我們使用媒體附件
就是在NotificationContentExtensions裏用過的
因爲它們會被添加到通知內容裏去
你可以在內容擴展裏看到它們
所以當你收到通知的時候
在didReceive:notification方法裏
你可以從內容中抽取附件
我剛纔說過
附件是系統管理的
被移動到了一個單獨的區域
所以你是訪問不到的
所以你需要告訴系統你想開始使用它
並告訴系統什麼時候完成
當你可以訪問了就如同文件一樣使用
在這個例子裏我要把它加到圖片視圖中
這就是我現在的通知
你能看出這個人準備來派對了
比最初的好多了
而且是我們的自定義UI
我們想讓用戶看到額外信息
就添加了它們
我們想添加圖片也做到了
現在我們就差最後一步了
我們想讓它具有交互性
我們想實現動作
我們現在就做
動作
默認動作在默認情況下的工作方式
和你在iOS 8裏用的一樣
它們會傳送給應用當用戶點擊按鈕之後
應用會接收到請求
然後這條推送就立即關閉了
非常方便 因爲這種行爲
你經常會用到實現起來也很簡單
但有時 你想讓用戶知道動作的結果
就像剛纔的日曆邀請例子裏那樣
就是當用戶點接受之後
內容裏會高亮顯示我接受的邀請
你可以在NotificationContentExtensions裏做到
你需要在通知擴展裏攔截這個動作
之後動作會傳給擴展
它可以決定延遲通知的關閉
這樣就有時間處理動作 更新UI
結束之後再關閉
這很簡單
你通過NotificationContentExtension協議中的第二個方法
這個辦法是可選的
你不必實現它
如果你不需要攔截動作的話
但如果你確定要實現它
那你就要自己處理所有動作
通知裏的全部動作
你不能只管其一不管別的
當你收到通知時
你可以給服務器發送一條迴應
更新服務器上的信息
當收到來自服務器的迴應
你需要更新UI 表示用戶會參加派對這是當然的啦
完成之後 你就可以關閉通知了
這樣界面就在關閉之前得到了更新
如果你想把動作轉發給應用的話
也是可以的
如果你需要進行額外處理
或者你想要把代碼集中到一起
你只需使用不同參數調用completionHandler
我們這樣做話 當我們收到推送
點擊它 然後可以更新UI
然後再關閉
你在我的示例代碼中也看到了
我們實現了接受和拒絕兩個動作
最下方還有第三個動作
因爲有時當你回覆派對邀請你想要知道
我們想告訴你的朋友能去參加有多興奮
或者不能去參加有多遺憾
你可以點擊評論按鈕
文字輸入動作
評論動作是文字輸入動作
就像我們在iOS 9引入的那個
用法是一樣的
除了全新的非常棒的構架
這一個文字輸入動作
它的新一點的API
你可以在文本區設置佔位符
當你創建動作時你可以把它加入到你的類別裏
這樣它就會和通知一起顯示了
所以當用戶點擊評論按鈕時
文字會顯示出來
由於它是個動作 和其它一樣
你可以以同樣方式處理
你可以在你的擴展裏攔截它
在那裏進行處理
下面是做法
你收到通知
你檢查看它是不是文字輸入動作
你抽取用戶輸入的文字併發送到服務器
結束之後 關閉通知
流程就是這樣
你點擊 然後打字
這個通知也有個需要處理的問題
我想要回復邀請但是上面只有一個發送按鈕
我沒法選擇是接受還是拒絕
我們想要保留文本區
但同時增加兩個按鍵這樣我就可以選擇是接受還是拒絕
比如這樣
可以嗎？
沒有新的API能做到這一點
沒有新的API是因爲已有的就可以做到
你可以使用已有的UIKit自定義輸入輔助視圖API
給通知中的文字區添加自己的自定義視圖
爲了做到這一點首先要做的是
確保你的控制器可以成爲第一響應器
這會讓UIKit系統知道
它是事件響應鏈中的一環同時也讓通知系統知道
你不想使用默認的文字區
然後你創建一個自定義的inputAccessoryView
在這個例子裏我添加了一個文本區和兩個按鈕
然後當我接收到用戶的回覆也就是動作
來自用戶的評論動作
我可以將它設置成第一響應器這樣我的文字區
以及鍵盤就都出現了
這兩個調用都要進行
因爲第一個把視圖控制器設置成第一響應器
這樣文字區就顯示出來了
第二個將文字區設置成第一響應器
這樣鍵盤也顯示出來了
你會發現在這個例子中
我不關心它是否是可編輯的動作
你可以使用常規操作
因爲我會從自己的inputAccessoryView中獲取來自用戶文本
所以我可以訪問那個UI
這樣做的結果就是當你點擊評論之後
你可以輸入你的回覆
同時還能同意或拒絕這次邀請
關於NotificationContentExtensions今天就說這麼多
還有一些別的小API
若有興趣 可在這周稍後的實驗室與我們探討
我們今天講了如何在自定義UI中使用附件
在iOS X系統中的通知內容擴展中
我們學習瞭如何下載以及在通知中插入附件
通過使用服務擴展程序
我們瞭解瞭如何自定義UI徹底自定義UI
使用內容擴展加入你的特別內容
可以使用媒體附件也可以處理用戶的交互
想了解更多的話有一個專門有關這次演講的網頁
今天早些時候我們辦了另一場演講沒有參加的話建議看看
瞭解更多新用戶通知框架
以及更多的有關服務擴展的細節
謝謝