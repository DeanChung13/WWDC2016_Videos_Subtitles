用廣色域來工作
廣色域顯示的理解與優化
歡迎大家的到來
我希望每個人都有個很棒的WWDC
我叫Justin Stoyles
我是Apple圖形和媒體組的一員
我很高興今天和你們談談用廣色域來工作
我們今天要覆蓋一些主題
首先我們要討論一些核心的顏色概念
我們會談談什麼是廣色域它爲什麼重要
然後我會交給Patrick
他會向你們展示過程
把廣色域資源加入應用的過程
然後我會交給Steve
他會談談渲染廣色域
讓我們開始
我已經提到過 我很高興今天能和你們談談廣色域
這是因爲我們正在改變
我們處理廣色域 或者一般來說顏色的方法
在Mac和iOS平臺上
一個好的開始的點是上世紀90年代
Apple一直處在解決計算中的顏色問題的前沿
最好從ColorSync說起
ColorSync是Mac的顏色管理平臺
它是上世紀90年代開發的當時
Apple和其他有相同想法的公司聚在一起
有一個想法那就是顏色管理和再現的標準
可能可以開始解決一部分問題
工程師和設計師與顏色打交道時面對的問題
該組後來成爲國際顏色聯盟（ICC）
你可能感到熟悉
ICC的工作成果被融入ColorSync中
我們也把那包含進了OS X
Apple現仍然處於顯示技術的前沿
在多個產品線上我們現在有漂亮的retina顯示
人們非常非常喜歡它們但什麼是下一個前沿？
好吧
去年我們宣佈了漂亮的有P3顯示的新iMac
我們獲得了巨大的反響
它們多顯示25%的顏色
它們有P3色彩空間人們很愛這點
如果你再快進一年
我們有新iPad Pro 9.7寸顯示並有True Tone技術
所以我們又更進了一步
現在有很多事在下面發生
我們今天會試着涉及到這些主題
我會從核心的顏色概念開始
讓我們從簡單的開始什麼是色彩空間？
一個色彩空間是一個環境在其中顏色可以被比較和顯示
它可以是1 2 3 4維空間
是由顏色成分的亮度定義的
顏色成分也經常被稱爲顏色通道
一種表示方法你可能很熟悉那就是RGB
這和顯示屏密切相關
你的子像素是紅 綠 藍
要考慮這些顏色通道你可以想
每一個顏色通道的亮度
決定你在另一端看到的顏色
有多個不同的色彩空間
我提前了RGB空間在顯示中很流行
但是還有很多有灰度空間
被用在單色打印上
在彩色打印中我們通常用CMYK空間
如果你嘗試進行計算和轉換
我們通常用色彩空間比如LAB
它是設備不相關的
現在我們有色彩空間和顏色通道
我們現在想創建一個座標系統
我們可以比較和計算顏色
這就是顏色基色的概念
顏色基色通常落在
你可以在特定的顏色通道上達到的最大值
在這個RGB色彩空間的例子中
你可以看到顏色基色是我們在色彩空間上定位點1.0的地方
對黑色 在任何一個顏色通道上都沒有飽和度
所以我有0 0 0對白色我有1 1 1
對紅色我只飽和紅色通道我有1 0 0
非常簡單
當我們提到色域我們實際上是說所有
可以被那些單獨的顏色通道的組合定義的顏色
現在你知道一些基本的
我們將會在這個演講中討論的顏色概念
那麼什麼是廣色域？首先我們要談一下
目前的行業標準是什麼
標準RGB或者sRGB是目前計算機界使用最廣泛的色彩空間
它基於BT.709標準我們用的伽瑪大約是2.2
典型的光照條件在這個例子裏是D65
這是iOS的默認色彩空間
這實際上也是很多平臺的默認色彩空間
這很方便因爲有一些平臺
有顏色管理還有一些沒有
當目前存在的很多內容都是sRGB
你可以對你獲得的內容做一些假設
並且它會在另一端被如實重現
但事情不永遠是這樣
sRGB可以很好的用來描述我們日常工作中使用的顏色
我們的系統可以很好地顯示這些顏色
但是很多顏色並不適合sRGB
很多紡織品是用墨水和染料設計的
有很多顏色是在sRGB之外的
主要是因爲這些顏色很捉人眼球
它們非常生動和令人印象深刻如果你看看足球做爲例子
有很多球衣的顏色實際上在sRGB之外
因爲他們在進攻吸引了我們的注意
無論是看你孩子的足球賽
還是歐洲盃
你會看到很多球衣的顏色
實際上不能用sRGB描述
很多產品實際上也是用sRGB之外的顏色設計的
這些產品是我們每天打交道的
但是最迷人的例子就是大自然本身
日落 秋葉 熱帶水體
這都是大自然中的事物含有sRGB之外的顏色
我們想要顯示它們
好的事情是你可能有很多相片
你在相機上拍攝的特別是如果你用RAW格式
它實際上包含很多顏色數據
但是你無法在顯示器上看到如果你的顯示器只支持sRGB
那對此我們要怎麼辦？
去年我提過我們引入產品
有一個新的色彩空間這個色彩空間是Display P3
在我們的iMac和iPad Pro 9.7中
我們用這個色彩空間
它是基於SMPTE的DCI-P3標準
但它有一點不同
DCI-P3是爲數字投影定義的色彩空間
它在那種觀看條件下表現很好
但是我們的觀看條件有一點不同
sRGB表現地很好對於定義一個標準
工作在我們的觀看條件下
所以我們採用了相同的伽瑪和典型光照條件
爲我們的白點 像sRGB
這是Display P3和DCI-P3的關鍵區別
爲了理解什麼顏色在sRGB之外
但我們可在Display P3中描述
我會試着用行動向你展示
這是我相片庫中的一張相片我用photos導出它
在Display P3色彩空間
它是很漂亮的相片
即使我們今天是用一個sRGB投影在看它
或者如果你在觀看視頻如今你在用sRGB觀看
這個相片還是看起來很好
但是相片上有很多東西你可能不能馬上發現
但是實際上有很多顏色實際上沒有被sRGB描述
這是sRGB色域外的顏色
這種情況下你最終得到的是對這些區域進行色調分離
所以這些顏色被壓縮到sRGB色域的邊界
我們要怎麼解決這個情況？
我們要把更專業的工作流程轉移到我們的移動平臺
要使這成爲可能
不僅僅是把廣色域顯示加入你的系統
還需要一起做一些其他事
其中之一是我們需要更新出廠校準
所以現在我們所有的產品都有單獨校準的顯示
在每臺設備上你可以相信顏色
是準確一致的
最後我們在iOS中建立了整個系統範圍的顏色管理
這就是我們所做的事
但是我們不能只是建立一個相同的顏色管理系統
使用在Mac上使用的相同方法
有不同的考慮和限制
當與移動平臺一起工作時
一個要考慮的就是無數的應用
已經存在在iOS生態系統中
這些應用是在sRGB中開發的調整了顏色
和性能在sRGB中
我們怎麼保證這些應用
仍然可以運行在有顏色管理的平臺上
而不會影響性能和顏色
我們所做的就是在sRGB的基礎上創建
所以我們引入了一個擴大範圍的sRGB色彩空間
這是我們用來工作於廣色域的工作空間
我們用相同的sRGB基色
我們用相同的伽瑪2.2相同的白點
有趣的差別是我們允許值
大於1或小於0
允許我們保持相同的性能
和外觀對所有爲sRGB開發的應用
但是還可以用負值和大於1的值
允許我們表達任何可見光譜內的顏色
同時仍然保持我們的定位點在sRGB中
用來說明它的最好辦法是用一個例子
所以讓我們假設我想要Display P3中最飽和的紅色
那會是1 0 0
如果想在擴大範圍sRGB中表示它
那會看起來像這樣
在紅色通道 我有一個值是大於1
在綠色和藍色通道我實際上用負值
所以我減少了綠色和藍色增加了過飽和的紅色
這允許我得到一種顏色是在sRGB色域之外的
同時使用相同的sRGB定位點在擴大範圍sRGB中
有趣的事是如果你用一種像素格式
允許你用很大的負值和正值
這種方法允許你表達任何可視光譜裏的顏色
所以這是可擴展的
說到像素格式sRGB標準是8位
8位用來描述sRGB中的顏色已經夠大了
不完美但是還不錯
一個簡單的例子來描述
之間的區別在我們希望sRGB的精確度
和更廣色域的精確度之間的區別
是用這個例子
假設我想要在家建造一個樓梯
從地下室到一樓
我會用8個臺階
我也許會用12個 但是讓我們簡單地假設我會用8個
這對我是合適的高度
如果我想要把樓梯擴展到二樓
我不會僅僅用相同數量的臺階
當我們用數字編碼顏色時
這對你嘗試表達更多顏色講得通
你想要更精確
每顏色通道8位對sRGB足夠了
如果我們是說使用sRGB之外的顏色
那麼我們的建議是每顏色通道使用16位
現在在我交給Patrick前我想要用另一點來結束
我們仔細檢查了整個系統並且更新了所有框架
和工具使它們能正確理解顏色
但是如果你們用開源工具開發應用
或者從頭開發了你自己的圖像處理管道
你需要採取行動來確保
你所用的工具能正確理解顏色
此外 我們已經幫你們處理好了
關於這的更多我會交給Patrick
謝謝Justin我是Patrick Heynen
我是Cocoa框架組的高級工程師經理
我想問廣色域從何而來？
答案是它實際上不僅僅來自於衣服
不 它來自你
也就是它來自應用及其內容
和你的應用提供的用戶體驗
哪種內容可以爲廣色域進行修改？
第一個可能是你們最熟悉的
就是靜態圖像資源
它們是PNG JPEG和單獨的圖形文件
你捆綁進了你的應用並且一起發行
和你的應用包一起給你的用戶
另一類是文檔和基於網絡的圖像資源
它們是單獨的圖像內容
你可以從網絡服務下載
或者儲存在文檔數據中
還有其他類
比如高級媒體比如Live Photos
或者來自iPhone iPad內置攝像頭的內容
我不會說太多細節
關於廣色域對這些種類內容的影響
但我推薦你去看看iOS攝影進展與
在iOS上編輯Live Photos和RAW演講
以獲知更多細節
最後還有一個內容是GPU紋理
如果你的應用工作在GPU一級
比如你的遊戲引擎或者圖形軟件的高級部分
並且你會發送顏色信息
以紋理或着色器值的形式直接發送給GPU
對廣色域內容還有其他要考慮的
我也不會深入太多細節
但我要介紹同事Dan Omachi對此所做得極好的處理
在Metal的新特性第二部分
好的讓我們回到顏色問題
Justin早前做了很好的解釋
但這怎麼應用到應用？
應用內容可能來自一個很寬範圍的來源
顏色的豐富程度也在一個很寬的範圍中
從灰度
一直到16位廣色域內容
同時
設備和顯示的顏色能力也處於很寬的範圍中
比如iPhone 5只能顯示sRGB
一直到最新的iPad Pro
可以完全顯示P3顏色和擴大範圍sRGB
你要這麼銜接這些差別？
我們將解決這些顏色問題
支柱就是顏色管理
什麼是顏色管理？
顏色管理的工作就是確保
圖像在所有輸出設備上看起來都是相同的
不管它被編碼到哪個色彩空間
或者最初它是如何被創造的
就是這些但它是怎麼工作的？
顏色管理從每個圖像開始
或者有相關聯的色彩空間的內容種類
有時被稱爲顏色配置
這告知系統顏色的實際含義
然後顏色匹配過程通過算法映射
這些顏色到特徵和輸出空間
屬於你要渲染到的設備的特徵和輸出空間
當然這是一個計算過程而且不是免費的
實際上每個像素都會被涉及會被轉化和匹配
而且還需要注意這是有可能有損的過程
特別是如果你要
從更廣的色域轉化到更窄的色域
假設一個16位的P3內容降到8位的sRGB
這會造成色彩保真度的丟失
這是需要注意的事
這是重要的方面但是有好消息
第一個好消息是這個顏色匹配過程
它們用算法定義的方式
我不想講解它們背後關於顏色科學的細節
但是結果是那些計算很容易被硬件加速
不論是用CPU還是GPU
這導致下一個好消息
我們把這個功能集成到了系統本身
它們都通過Quartz 2D自動運行
Mac上的ColorSync以及核心動畫
實際上你需要確定的是
你的內容被正確的加了標籤
在這種情況下 要正確顯示你的圖像不需要任何代碼
並且讓顏色正確顯示
平臺顏色管理
Justin逃避了的macOS
從它一開始就有顏色管理
有些人甚至可能會說早於它的開始
當它在ColorSync時代之前被稱爲macOS
所以這沒有什麼新的但是在iOS上有一些新的
從iOS 9.3開始
我們在大部分設備上有自動顏色管理支持
這就是顏色管理解決顏色問題的關鍵
現在讓我們談談
一些設計上的考慮和工具鏈
和平臺服務是如何被增強的
來適應在你的應用中獲得廣色域的內容
首先它總是從設計開始
需要考慮的重要的事是
從設計上看你要在什麼時候達到廣色域
我首先要說的是
很重要的是當這樣做有意義時才使用廣色域
而不是在任何地方
請記住我們日常生活中接觸的大部分顏色
其實被包含在漂亮的sRGB三角形中
這是大部分顏色所在之處
然而還有那些漂亮的新的生動的飽和的顏色
你的應用使用它們是有意義的
所以很重要的一點是把廣色域內容看成
你可以使用的一個工具
當生動的顏色確實能提高用戶體驗時
並且爲你的應用增加一些價值
並沒有必要更新你的所有內容
並且馬上升級到P3
這並不是一種技術轉變
這只是一種新的你可以使用的創造性工具
在你想用它時
好消息是我們改進了工具鏈支持
使逐漸採用廣色域成爲可能
讓我們假設你想升級一些內容到廣色域
什麼是需要考慮的？
小心是很重要的
當你升級設計文件到廣色域
一個常見圈套是僅僅賦予一個新的配置文件
它從sRGB開始賦予一個新的廣色域配置
這是一個錯誤這僅僅重新映射
已有的顏色信息到新的色彩空間
這相當有效但可能不是你想要的
因爲這只是拉伸所有顏色
使它們生動而且設計文件的外觀
不可避免地被改變
重要的一點是應該轉而使用轉化到P3
這會做一個顏色匹配操作
你的設計結果不會改變它的外觀
但是它被準備好使用
並且有一些內容被提升到那些漂亮的
生動飽和的P3顏色
當你進行廣色域設計時
這很重要我們強烈推薦
你使用Display P3顏色配置
作爲你的工作文檔配置
並維持最高的顏色準確度和最高質量
工作在每通道16位的顏色模式下是個好主意
當然能看到你的設計很好
所以如果你要在廣色域下工作
最好進行設計工作
在可以渲染廣色域的系統上
比如2015年末推出的iMac或其他有這個能力的硬件
當來到產生產品的階段爲了輸出資源
使用16位嵌入Display P3ICC配置的PNG文件很重要
這是一種黃金標準
把內容轉換成廣色域內容
一個簡短的注意事項
有一些很流行的內容生成工作流程
它們有不同名字
我要特別討論AdobePhotoshop工作流程
他們被稱爲爲網絡保存和導出資源
這些工作流程很多都沒有完成向廣色域的轉變
它們不能導出16位P3內容
所以現在不要用它們
使用一些變通方法使用保存爲PNG格式
使用16位並且嵌入顯示配置做爲一個變通方案
這就是設計過程和廣色域如何影響它
現在讓我們談談工具和如何使用它們
要採用你在設計過程中得到的內容
我要談到的第一件事
是內容工具故事的中心
是Xcode資源分類
你可能對此感到熟悉
這是Xcode中的普通工具
允許你整理並分類你的圖像資源
標記它並提供元數據把它發送到你的應用中
資源分類會爲你做什麼？
它們是最好的靜態資源部署工具
我們自動對你的資源內容進行顏色修正
並對構建目標進行優化
所以即使你的設計師是完美的
並且總能交付內容含有正確的配置
和所有正確的信息在他們的交付物中
但事情並不總是這樣
這就是自動顏色修正發揮作用的時候
來確保我們匹配並標準化全部顏色
到合適的目標設備的工作空間
我們還自動進行像素格式優化
確保對設備使用正確的位深
最後 但當然不是最不重要的
資源分類是應用切片的途徑
應用切片是其瘦身功能的重要組成部分
它確保只有相關內容被傳送給客戶
在一個特定設備上不相關內容不會被傳送
那我們做了什麼讓資源分類更容易
與廣色域內容一起工作？
第一個重要改進是我們現在支持16位的源內容
併爲16位的圖像資源提供乾淨的端對端路徑
我們有16位半負載來儲存它
但是你在Xcode 8中可以用到它
下一個重要的事是我們增加了給顯示色域分類的功能
這是什麼意思？這說明你
在查看器中有一個新的選項來提供並剪裁優化了的資源
爲sRGB或Display P3
顯示色域和設備通過那些特徵匹配
三個簡單選擇
這就是這個特性
Xcode提供它來整理資源
但你怎麼利用它？你怎麼考慮利用它？
這裏有三個簡單的選擇
選擇一
不做任何事
這可能看起來激進
但是完全可以這麼做
因爲如果你不對資源分類進行改變
你可能不需要這些生動的新顏色
你將繼續在所有設備上如實渲染8位的sRGB內容
沒有什麼會改變你不需要更新所有東西
只需要確保它能運行在新硬件上
這完全是個有效的選項
當然這表示你的應用不會包含任何廣色域
這是完全可行的設計選擇
這是部署選擇的結果
假設你想要在你的應用中使用廣色域
帶來選擇二升級到P3
我們把這種方法稱爲通用P3資源
它所要做的是使用16位Display P3文件
可能從你設計師那得到它
然後在資源分類中替換你已有的資源
使用這個升級過的資源
在創建時會發生的是我們會自動生成
一個sRGB變種 從16位通用Display P3主檔生成
我們會進行高質量的顏色匹配
高質量會降級到8位
然後在瘦身和內容選擇時
我們確保正確的內容變種被選擇用在適當的設備上
但是如果你對自動轉換不滿意
你想要完全的控制
好消息是這也提供給了你
這就是選擇三 優化資源
這基本上是個很簡單的選項
你提供一16位Display P3內容和你的原始的8位sRGB內容
我們給你提供地方來整理這兩類資源
他們會被創建進你的應用並且被正確的選擇和瘦身
這就是廣色域資源和資源分類
我現在想要介紹創造內容
假設我們有這個漂亮的色度環
假設我們有這個漂亮的色度環
這好多了
我已經決定了這會獲得好處
從一些更生動的飽和顏色
這是怎麼完成的？讓我們看看這裏
這只是一個簡單的漸變一個輻射漸變
我只想要強調這裏
在漸變中的這一點是一個純的飽和綠色
我從這開始
我要怎麼升級它？
我首先要做的是因爲我要整理類型
我要創建它的一個備份這樣就不會弄壞已有的資源
我在這起一個新的名字
我現在準備好開始工作了
我要做的第一件事
是更新到每通道16位
我們現準備好用16位工作了
然後是十分重要的轉換到配置
我要做的是
把這變成Display P3顏色配置
我們弄好了
實際上我可以在下面的文檔配置中確認
Display P3 16位組件我準備好了
讓我們看看這個漸變發生了什麼
讓我們看看最愛的綠色
這很有趣是嗎？這個綠色並沒有改變
注意這個色度環的外觀完全沒有改變
和賦值相比這是轉化計劃中的結果
但是相同的綠色現在只有70%的飽和度
這表明有多少淨空間
來擴展到更廣的色域並得到更純的綠色
我想要那麼做但是我不想要一整天都在講臺上
我會重新應用漸變的預設
現在一切應該都回到開始的樣子
100%飽和但是現在是在純的P3廣色域空間
現在我有我漂亮的資源了
我會繼續並保存
當然這只是一個設計文件
我只有保存它以後才能在我的應用使用它
我將這麼做
我將把它保存爲不是Photoshop raw而是PNG
我要確保嵌入了顏色配置
並保存它
好的 我完成了
其實我還沒完成我只完成了設計過程
我沒有把它加入到我的應用
讓我們這麼做
我的應用在哪？我的應用在這這是我的應用 沒有修改的
這是我已有的sRGB P3色度環
我想要做的是來到這
到這個彈出菜單來顯示sRGB和Display P3色域
這會立即顯示一系列額外的分類選項
我把我的P3色度環放到這個位置
我弄好了現在如果我構建並運行
它會把它們都編譯到我的資源分類中
若我在iPad Pro 9.7英寸上運行
我會得到16位Display P3資源
在一個sRGB設備上如iPhone 6 我會得到該資源
好的
這就是在應用中加入內容
我們已經談過了工具和怎麼用它們處理內容
現在是時候討論部署要考慮的事
你使用完那些工具後發生了什麼
這會怎麼影響你的應用的運行
有了資源分類部署應用切片
將確保適當的變種被傳遞給給定的設備
這很重要
因爲有可能有很多內容
是你應用的一部分
有了切片 我們確保沒有負載成本
對你的實際最終用戶
對將廣色域內容加入你的應用
因爲我們確保有了應用切片
廣色域內容只被發送給廣色域設備
sRGB內容發送給剩下的設備
它不會浪費不相關設備的空間
在Mac上其實沒有新東西
NSImage總是可選擇最好的表達
從資源分類中可用的表達裏
它會繼續這麼做
根據你的目標顯示器的特徵
比如如果你使用的是廣色域iMac
你有P3內容在你的資源分類中
它會在渲染內容時使用這些資源
就像Mac上1X和2X資源的行爲一樣
NSImage和NSImage視圖和所有有關的AppKit類
確保自動刷新內容
當顯示器特徵改變時
比如你的窗口在內部和外部顯示器之間移動
或者顏色特徵或後臺縮放比例改變
這很好
但是數據是怎麼儲存的
這會對你的應用有什麼影響？
一個好消息是在構建時我們盡了很大努力
來優化像素格式和儲存特徵
爲你的資源分類的所有圖像內容
並儘量用最有效率的方法來做到這些
盡我們最大的能力
我們現在用16位每成分來儲存廣色域內容
我之前提到過
這允許你有端到端16位的顏色精度
在你的應用資源中
我們還有壓縮
這很方便因爲16位和8位相比有更多數據
更多的數據不可避免的導致更大的足跡
除非你使用壓縮
現在我們總是有壓縮我們總是有無縮壓縮
比如對PNG文件發生的
但今年的新特性是一些有損壓縮選項
來中和 你知道的 應用足跡尺寸
第一個我們稱爲基本壓縮
這是一個和JPEG很像的壓縮系統
除了增加的紅利它還可以處理透明度
它有相似的視覺和性能特徵
好消息是它表現的很好
在所有設備上
就像JPEG一樣
它是你可以依賴的
付出很小的視覺質量損失
來獲得很好的儲存特性
今年新的還有
我們有令人興奮的選項叫做使用ASTC的GPU壓縮
ASTC代表高級可縮放紋理壓縮
是用GPU壓縮過的紋理格式
被很多Apple設備上和其他系統上的現代GPU支持
我們把這個選擇帶到你的資源分類中通過兩種不同形式
一是GPU最佳質量
是固定的比特率4位每像素ASTC壓縮模式
是很好的選擇 大致上可以在視覺性能上
和視覺保真度上和高質量JPEG相當
我們還有GPU最小尺寸
如果你真的想極大地優化你的足跡
和你的內存足跡那麼你選擇這個尺寸
這是1位每像素固定比特率編碼
有優秀的存儲特性
當然因爲不是每個設備的每個GPU都支持
使用ASTC格式
我們更進一步爲你自動生成
一個軟件後退爲沒有這個功能的設備
這很好的一點是它意味着你不需要擔心
你的內容會不兼容
對所有支持的設備
我們會自動生成這個後退
合適地使用 瘦身 路由它
對不支持ASTC的設備
所以你可以使用GPU壓縮
不需要冒破壞兼容性的風險
一個簡短的註解關於GPU如何壓縮
廣色域資源
我們用ASTC低動態範圍（LDR）壓縮模式
就是說廣色域內容實際上需要
在壓縮前被降低到8位
因爲LDR是每樣本8位的壓縮格式
好消息是我們爲你進行這項工作
我們自動進行一個高質量的8位轉換
在構造中當我們處理你的圖像時
但是我們保留可能含有的廣色域顏色
在你的原始16位源內容中的顏色
通過Display P3色彩空間內編碼和壓縮
這樣就保留了顯示所有顏色的能力
在Display P3色域中的所有顏色
這就是部署
關於部署特性的一個小討論
但是這個演講是關於顏色的
顏色怎麼樣？
特別是UI中的顏色
UI中的顏色
一個重要的觀察是你在屏幕上看到的大部分像素
大部分應用繪製的並不是來自圖像
即使在這次演講中獲得了重要地位的應用
屏幕上的大部分像素實際上是純色
在你的應用中用代碼繪製
廣色域顏色的結果是
對僅僅工作在這麼簡單的層次帶來了新的挑戰
讓我們談談它
特別是我想談談第一個挑戰
實際上是談論顏色
因爲這是一個被低估的問題
被低估的問題
一般當設計師和工程師交流
通過書面形式 或者可能甚至是口頭或視覺形式
代碼的交流通常假設了sRGB色彩空間
這表明你可能曾經看到顏色被寫下來
像是RGB 128 45 56這樣的格式
很簡單 他們不告訴你這是在什麼色彩空間
它假設每個人都知道是什麼顏色
因爲每個人都使用sRGB 不是嗎？
不再是了
這對和廣色域一起工作不再足夠
那你要怎麼辦？
你能做的最重要的步驟是指出
指出什麼色彩空間是你工作和交流的
或者寫下 或者傳送那個顏色
當你進行廣色域設計時用Display P3而非sRGB
並標明它
如果你需要使用比0到255的8位表示更高的精度
那麼使用浮點數
做爲一個例子 下一次你在電子郵件裏發送顏色
你可能會把它們寫成像這樣的
有一個註解 P3 255128 191等等
選擇顏色
這是你怎麼交流顏色
但是那個顏色是從何而來的
可能是你選擇它可能是設計師從哪選擇了它
他們是怎麼選擇顏色的？用一個色板
這是Mac的標準色板
是AppKit的一部分叫做NSColorPanel
這當然是個很熟悉的UI但是它也遭受
一些我們剛纔提到了的調用顏色遇到的限制
典型的 我們選取紅 綠 藍的值0到255的數字
色板總是支持在不同的色彩空間中選擇顏色
但是這不總是一個直觀和簡單的用戶體驗
我很高興地說我們實際上做了一些改進
在macOS Sierra的色板中
使工作在廣色域變得容易一點
我們做的第一件事
是我們把最常用最重要的工作空間
主要是Display P3和sRGB放在右鍵菜單裏
在數字選擇器的動作菜單裏sRGB當然還有Display P3
我們做的下一件事是我們實際上允許一個選項
改變它的顏色的數字顯示方式從整數變成浮點數
所以你可以標準化浮點顏色
如果這對你的工作流程有利
另一個令人興奮的事是我們在色度環或環選擇器中完成了它
我們實際上改變了它的實現所以它實際上可以渲染
整個P3顏色的色域當使用一個合適的顯示器時
我們還添加了一個新的右鍵菜單允許你
使用這個自動行爲
它自動切換功能 在P3
和sRGB之間 當你用多臺顯示器時或者固定在特定色彩空間
如果你想看到更多
現在我們選擇了我們的顏色我們知道怎麼溝通它
其實要使事情發生我們需要寫代碼 不是嗎？
我們怎麼在代碼中構造廣色域顏色？
我們引入了兩個新的方便的構造函數
在AppKit和UIKit中直接使用Display P3顏色數字
這是NSColor Display P3紅 綠 藍 透明度
和UIColor Display P3紅 綠 藍 透明度
很好的方法和來自你的設計師的P3顏色一起工作
但是當然你的代碼可能工作在擴大範圍sRGB顏色上
這可能並不來自設計師但是可能來自一個不同的子系統
或者一個提供擴大範圍sRGB顏色的API
你怎麼和這些一起工作？
好消息是我們擴展了已有的標準
NSColor和UIColor的紅 綠 藍 透明度構造函數
並不固定在他們的輸入成分並且允許值被表示成
大於1和小於0
這樣你可簡單構造擴大範圍的sRGB顏色
然後是儲存顏色
如果你想要
把顏色放入你的文檔數據或者用某種形式歸檔它們要怎麼做？
這樣做的話要特別小心
因爲和這個生態系統的其他部分一樣
有很多傳統上的關於顏色空間的假設
並假設每個人說的是相同的事
當你傳遞一個紅 綠 藍數字
你只需要三個數字對嗎？
只需這麼做表示一個顏色這有什麼問題？
事實證明確實有問題
因爲你無法分清sRGB
和P3顏色且你可能做了錯誤選擇
結果在你的文檔中是錯誤的顏色
我希望你考慮一下
在使用廣色域顏色的時候同時編碼一個兼容的sRGB顏色
這允許你的應用特別是舊的版本
因爲這是文檔數據
你需要考慮向前向後兼容
允許舊應用繼續得到sRGB數據
並繼續把它當成sRGB這是當時做的假設
而新的軟件知道新的廣色域代碼
你一起保存的代碼
你怎麼創造兼容的sRGB顏色？
在iOS上你可以用CGColor.convert API
在macOS上你可以用珍貴的NSColor.usingColorSpace API
來把那些顏色轉化到sRGB色彩空間
我們實際上把這集成到了macOS本身中
你可能熟悉TextEditMac上的文字編輯應用
它的文檔格式是RTF也就是富文本格式
一直存在並被支持
被Cocoa文本系統作爲它所需的文檔儲存格式
當你對一個文本範圍添加一個顏色
它實際上被儲存在RTF文檔裏的方式
是簡單的紅 綠 藍 0到255
這會造成問題我想現在你們可以理解
因爲我們不知道那些紅 綠 藍值
屬於哪個色彩空間而且它不允許你表達整個範圍
所以我們採取了行動
我們的成果是改進RTF標準
以及我們怎麼讀寫RTF至少在我們的平臺上
通過包含一個擴展的顏色表
這實際上註釋了每個顏色元組
它現在被轉化成16位整數
包含單獨的色彩空間信息
允許你在多個色彩空間定義顏色
這很好
但是這是加利福尼亞州我們應該衝浪不是嗎？
這和顏色有什麼關係？
網絡上有顏色
關於廣色域和網絡的好消息是
只要你的圖像內容有正確的標籤
和正確的顏色配置信息
那麼所有內容在網頁上渲染時都會被顏色匹配
只要你這麼做你就準備好了
還有現在有媒介查詢可以用來解析資源
在P3和sRGB兼容設備間這真的很方便
最後現在有WebKit提案
用來在除了sRGB以外的色彩空間中定義顏色
一種從CSS開始就有的情況
我要說的就這些我想把講臺交給Steve Holt
他會告訴你更多關於在你的應用中渲染廣色域的事
謝謝
謝謝Patrick
所以在你的應用中
你經常有從資源分類中獲得的資源
但是你可能獲得一些內容是由用戶產生的
或者來自網絡你無法控制的來源
也許你想要產生一些額外的資源作爲它的一部分
你怎麼在廣色域中來處理這些？
當你用廣色域繪製時
我將用一個簡化的例子
這是一個盒子它的一半被渲染
用Display P3中我們可用最飽和的紅色
另一半被渲染
使用我們可用的最飽和的sRGB顏色
不幸的是因爲這個視頻是被錄製的
而且你是用一個投影系統觀看直播
而它並沒有和我們的新顯示一樣的顏色保真度
我們需要作弊
我們實際上降低了兩種顏色的飽和度
我們看到的和代碼不完全一樣
和我將要展示的代碼的輸出相比
但是在一臺設備上渲染它它會在那
我是UIKit組Cocoa的框架工程師
當然我會從桌面的Cocoa開始
用廣色域Cocoa渲染
當你在桌面上
它已經有很好的顏色管理支持
你圖像和繪製中的顏色配置
如果你需要在代碼中手動繪製
而且需要在屏幕外完成推薦的做法是
用NSImage和drawingHandler API
它被調用時有當前語境
你可以在任何你使用NSImage的地方使用它
它可以在那工作
讓我們看一些代碼
很簡單就是設置一個尺寸
我們用我們想要的尺寸初始化NSImage
我們不想它翻轉
我們配置繪製處理器
我們從drawRect得到傳入的矩形
我們把它分爲兩半分配displayP3Red並繪製它
然後分配我們的sRGB紅並繪製它
然後返回真 因爲我們成功了我們完成了
這就是了 它是工作的
如果你目前在你的應用裏使用它
你已經做了正確的事
這就是桌面
那關於iOS呢？應該是一樣容易對嗎？
你們應該熟悉UIGraphicsBeginImageContext
這是一個很好的API
讓我們再看看代碼
我們得到尺寸我們用尺寸創造語境
我們分開我們的矩形 繪製我們的P3顏色和sRGB顏色
我們得到我們的圖像並結束語境
這就是我們得到的
這不對
爲什麼這不工作？
如果我們看看資料我們有一個有趣的點
我們標明瞭UIKit中的BeginImageContext API
只會返回一個32位整數語境
這表明你每個通道紅 綠 藍 透明度只得到8位
這極大地影響了我們能用它繪製什麼
因爲我們不能創建一個語境每個顏色通道超過8位
它不能顯示任何擴大範圍sRGB色域中的顏色
而且因爲已有的界面是用C語言寫的
我們不能擴展選項
我們也不想使UIGraphics成爲有更多選項的語境
所以我們在iOS X中提供了一些新API
它是UIGraphicsImageRenderer
它的工作方式很直觀
我會進入一些代碼
首先初始化我們的圖像渲染者對象
你可以重用它
而且它的屬性會保持相同在每個
你使用這個繪製處理器得到的圖像中
你只需要調用渲染器 圖像
你提供代碼塊就像平時一樣
你從描述確切屬性的格式裏得到的邊界
這個特定的渲染器所含有的屬性
然後你分開這個邊界
你得到並渲染P3紅色方塊
然後你設置和渲染sRGB紅色方塊
就像我們之前在AppKit中有的
我們有一個正確渲染了擴大範圍的
一半P3一半sRGB的紅色方塊
關於這個新API的一些其他要注意的事
默認它是完全被顏色管理
它還默認支持擴大範圍的sRGB色彩空間
它對這很聰明
若你有一個設備有P3顯示像是新iPad Pro 9.7英寸
我們會默認啓用它
你不需要進行額外工作
但是如果你在一臺不支持顯示擴展了的顏色的設備上
比如其他iPad和iPhone
那麼你會得到更標準的每通道8位
sRGB語境來進行繪製
所以我們沒有浪費額外的內存來得到16位浮點語境
它爲你做的其他事是管理CGContext的生命週期
你不需要操心結束這個語境
或者自己進行其他管理
對你應用中的任何舊代碼
它工作在UIGraphicsGetCurrentContext
所以如果你調用一些函數比如繪製矩形
你會做正確的事
這就是在屏幕外繪製
關於在屏幕上繪製呢？
我們重新開始一個新iKit
在UIView上我們有新的Swift 3
在Swift 3中被新命名 繪製
我們在這爲你做正確的事
當你在你的UIView子類中調用繪製
如果你是在iPad 9.7英寸上
我們會正確的在擴大範圍sRGB色彩空間中調用你的繪製方法
使用浮點像素格式
如果你不是在一個新設備上那麼
你得到現在你得到的每通道8位的sRGB
當然如果你有圖像我們有UIImageView
從iOS 9.3起被顏色管理
並在現在被繼續顏色管理
屏幕上的廣色域CocoaTouch
如果你需要知道你是如何渲染的
你可以看看你的視圖中的UITraitCollection的新特徵
在視圖控制器中被稱爲顯示色域
它獲得一個UIDisplayGamut枚舉
它的屬性是P3如果你在一個新的
P3類的顯示上 或者sRGB如果你在一個新的sRGB類的顯示上
這可以很有用如果你需要匹配一個特定
UI顏色和一個從資源分類獲得的資源
所以你正確地匹配顏色到你的資源
現在如果你知道一個視圖永遠都不需要
擴大範圍sRGB語境？
CALayer上有一個新的屬性是內容格式
這爲你控制CA創建的語境的位深
當它渲染那個視圖時
根據默認 在iPad Pro 9.7英寸上它會使用擴大範圍語境
在其他設備上它會默認使用傳統的sRGB語境
你通過使用這些格式文字來控制它
控制位深
在Cocoa中 回到桌面
NSView和UIView是一樣的
它會使用和NSWindow相同的語境來繪製
你可以看看所有傳統的屬性
有窗口後備存儲 屏幕目標配置等
如果窗口改變了顯示屏
viewDidChangeBackingProperties這個你視圖中的回調會被調用
你還可以監聽
NSWindowDidChange-BackingPropertiesNotification
它會在你的視圖窗口中被省略
這些是從很久之前你就一直在打交道的相同的東西
僅僅是提醒一下
NSWindow的支持屬性
包括顯示縮放 色彩空間和輸出顯示色域
和在iOS中一樣 你還可以控制從AppKit獲得的語境的位深
通過NSWindow的WindowDepth屬性
你可以把它設置成這些位深中的任意一個
所以如果你在一個廣色域顯示器上但並不需要額外的精度
你可以設成24位RGB
那它就不會爲你創建擴展的語境
我們今天學到了什麼？
好吧
你看到了廣色域的視覺和怎麼把這帶給
下一代的顯示和你的用戶
我們談了一點關於色域的知識和顏色管理
以及怎麼和廣色域內容一起工作
你想帶給你的用戶的內容
我們回顧了怎麼在你的應用中使用顏色
怎麼把你的繪製代碼提升到顏色的下一個層次
通過確保它在廣色域情況下能正確繪製
關於更多信息你當然可以獲得這些幻燈片
在這個演講的網站上
還有很多相關的演講
這是第1頁
請獲得它們
如果它們已經發布了我不會枚舉它們 它們有很多
請用WWDC應用觀看視頻或者在WWDC網站上在線觀看
謝謝